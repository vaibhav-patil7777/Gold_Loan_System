{% extends 'base.html' %}
{% block content %}
<style>
.payment-container {
    width: 90%;
    max-width: 1000px;
    margin: 70px auto;
    padding: 35px 40px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    border-radius: 18px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    color: #fff;
    text-align: center;
}
.payment-container h2 {
    font-size: 32px;
    color: #ffd166;
    font-weight: 700;
    margin-bottom: 30px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
th, td {
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 12px;
    text-align: center;
    color: #fff;
}
th {
    background: rgba(0, 0, 0, 0.4);
    color: #ffd166;
}
a.btn {
    background: linear-gradient(135deg, #ffd166, #fca311);
    color: #1d3557;
    padding: 8px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
}
button.btn-del {
    background: linear-gradient(135deg, #ef233c, #d90429);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
}
button.btn-del:hover {
    background: linear-gradient(135deg, #ff5c5c, #ff1e56);
}
</style>

<div class="payment-container">
    <h2>üí∞ Select Customer to Make Payment</h2>

    <table id="customerTable">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Mobile</th>
            <th>Action</th>
            <th>Delete</th>
        </tr>

        {% for customer in customers %}
        {% if customer.loan_set.last %}
        <tr id="row-{{ customer.loan_set.last.id }}">
            <td>{{ customer.id }}</td>
            <td>{{ customer.name }}</td>
            <td>{{ customer.mobile }}</td>
            <td>
                <a href="{% url 'make_payment' customer.id %}" class="btn">Make Payment</a>
            </td>
            <td>
                {% if customer.loan_set.last.status == "Completed" %}
                <button class="btn-del" onclick="deleteLoan({{ customer.loan_set.last.id }})">üóë Delete</button>
                {% else %}
                <span style="color: gray;">‚Äì</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </table>
</div>

<script>
// ‚úÖ AJAX Delete Loan Function
function deleteLoan(loanId) {
    if (!confirm("Are you sure you want to delete this completed loan?")) return;

    fetch("{% url 'delete_loan' 0 %}".replace("0", loanId), {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
        }
    })
    .then(response => {
        if (response.ok) {
            document.getElementById(`row-${loanId}`).remove();
            alert("‚úÖ Loan deleted successfully!");
        } else {
            alert("‚ö†Ô∏è Unable to delete loan.");
        }
    })
    .catch(() => alert("‚ùå Error deleting loan."));
}

// ‚úÖ Helper: Get CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
